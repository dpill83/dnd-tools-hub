<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One Shot Slot Machine Wizard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #1a1a1a;
            --bg-card: #242424;
            --bg-input: #2d2d2d;
            --text-primary: #e8e8e8;
            --text-secondary: #a8a8a8;
            --accent-gold: #d4af37;
            --accent-copper: #b87333;
            --border-color: #3a3a3a;
            --success: #7cb342;
        }

        body {
            font-family: 'Georgia', serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(212, 175, 55, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(184, 115, 51, 0.02) 0%, transparent 50%);
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .panel-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--accent-gold);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 2px solid var(--accent-copper);
            padding-bottom: 10px;
        }

        .wizard {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .step {
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .step.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 600;
        }

        input[type="text"],
        input[type="number"],
        input[type="range"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.1);
        }

        input[type="range"] {
            padding: 0;
            height: 6px;
            cursor: pointer;
        }

        .range-display {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 100px;
            padding: 12px 16px;
            background: var(--accent-gold);
            color: var(--bg-dark);
            border: none;
            border-radius: 4px;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Georgia', serif;
        }

        button:hover {
            background: var(--accent-copper);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: transparent;
            color: var(--accent-gold);
            border: 1px solid var(--accent-gold);
        }

        button.secondary:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: var(--accent-copper);
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        button.nav {
            flex: 1;
        }

        .step-indicator {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 10px;
        }

        .anchor-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .anchor-card {
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .anchor-card:hover {
            border-color: var(--accent-gold);
            box-shadow: 0 0 12px rgba(212, 175, 55, 0.1);
        }

        .anchor-card.selected {
            background: rgba(212, 175, 55, 0.15);
            border-color: var(--accent-gold);
        }

        .anchor-label {
            display: block;
            font-weight: 600;
            color: var(--accent-gold);
            margin-bottom: 4px;
            font-size: 11px;
            text-transform: uppercase;
        }

        .anchor-value {
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .act-preview {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .act-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .act-type {
            font-weight: 600;
            color: var(--accent-gold);
            font-size: 14px;
        }

        .act-controls {
            display: flex;
            gap: 6px;
        }

        .act-controls button {
            padding: 6px 10px;
            font-size: 11px;
            min-width: 60px;
        }

        .beat {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 6px 0;
            padding-left: 12px;
            border-left: 2px solid var(--accent-copper);
        }

        .dm-sheet {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            line-height: 1.5;
            max-height: 800px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .dm-sheet h2 {
            font-family: 'Georgia', serif;
            font-size: 14px;
            color: var(--accent-gold);
            margin-top: 15px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dm-sheet h2:first-child {
            margin-top: 0;
        }

        .dm-sheet h3 {
            font-family: 'Georgia', serif;
            font-size: 12px;
            color: var(--accent-copper);
            margin-top: 10px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .dm-sheet-row {
            display: flex;
            gap: 20px;
            margin-bottom: 6px;
        }

        .dm-sheet-label {
            color: var(--text-secondary);
            min-width: 80px;
        }

        .dm-sheet-value {
            color: var(--text-primary);
            flex: 1;
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .export-button {
            display: block;
            width: 100%;
            padding: 12px;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            transition: all 0.2s ease;
            font-family: 'Georgia', serif;
        }

        .export-button:hover {
            background: rgba(212, 175, 55, 0.3);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.15);
        }

        .success-message {
            background: rgba(124, 179, 66, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
            padding: 10px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 10px;
            text-align: center;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .dm-sheet {
                max-height: 400px;
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white;
            }

            .panel {
                background: white;
                border: none;
                box-shadow: none;
                page-break-inside: avoid;
            }

            .wizard {
                display: none;
            }

            .dm-sheet {
                background: white;
                border: none;
                max-height: none;
                overflow: visible;
                font-size: 10px;
                column-count: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- WIZARD PANEL -->
        <div class="panel">
            <div class="panel-title">‚öî Slot Machine</div>
            <div class="step-indicator">Step <span id="stepNumber">1</span> of 4</div>

            <div class="wizard">
                <!-- STEP 1: SESSION CONFIG -->
                <div class="step active">
                    <div class="step-title">Session Config</div>
                    
                    <div class="form-group">
                        <label>Party Level</label>
                        <input type="number" id="partyLevel" min="1" max="20" value="5">
                    </div>

                    <div class="form-group">
                        <label>Party Size</label>
                        <input type="number" id="partySize" min="1" max="8" value="4">
                    </div>

                    <div class="form-group">
                        <label>Session Length (hours)</label>
                        <input type="number" id="sessionLength" min="1" max="8" step="0.5" value="3">
                    </div>

                    <div class="form-group">
                        <label>Tone</label>
                        <select id="tone">
                            <option value="serious">Serious</option>
                            <option value="heroic" selected>Heroic</option>
                            <option value="spooky">Spooky</option>
                            <option value="goofy">Goofy</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Seed (for repeatable rolls, optional)</label>
                        <input type="text" id="seed" placeholder="leave blank for random">
                    </div>

                    <div class="form-group">
                        <label>Content Boundaries (comma separated)</label>
                        <textarea id="boundaries" rows="3" placeholder="e.g., no spiders, no child harm"></textarea>
                    </div>

                    <div class="nav-buttons">
                        <button class="nav" onclick="nextStep()">Next &rarr;</button>
                    </div>
                </div>

                <!-- STEP 2: PICK ANCHORS -->
                <div class="step">
                    <div class="step-title">Anchors: Theme, Villain, Location</div>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 15px;">These keep your one-shot coherent. Pick or randomize.</p>

                    <div class="form-group">
                        <label>Theme</label>
                        <div class="button-group">
                            <select id="themeSelect" style="flex: 1">
                                <option value="">Choose...</option>
                                <option value="faith">Faith</option>
                                <option value="greed">Greed</option>
                                <option value="revenge">Revenge</option>
                                <option value="forbidden_magic">Forbidden Magic</option>
                                <option value="missing_person">Missing Person</option>
                                <option value="relic">Relic</option>
                            </select>
                            <button class="secondary" onclick="randomizeTheme()">üé≤</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Villain/Opposing Force</label>
                        <div class="button-group">
                            <select id="villainSelect" style="flex: 1">
                                <option value="">Choose...</option>
                                <option value="faction">Faction</option>
                                <option value="monster_type">Monster Type</option>
                                <option value="villain_archetype">Villain Archetype</option>
                            </select>
                            <button class="secondary" onclick="randomizeVillain()">üé≤</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Primary Location</label>
                        <div class="button-group">
                            <select id="locationSelect" style="flex: 1">
                                <option value="">Choose...</option>
                                <option value="ruins">Ruins</option>
                                <option value="manor">Manor</option>
                                <option value="sewer">Sewer</option>
                                <option value="shrine">Shrine</option>
                                <option value="ship">Ship</option>
                                <option value="market">Market</option>
                                <option value="cave">Cave</option>
                            </select>
                            <button class="secondary" onclick="randomizeLocation()">üé≤</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Clock Length (steps)</label>
                        <input type="range" id="clockSteps" min="4" max="8" value="6">
                        <div class="range-display">
                            <span>4 steps</span>
                            <span id="clockDisplay">6 steps</span>
                            <span>8 steps</span>
                        </div>
                    </div>

                    <div class="nav-buttons">
                        <button class="nav secondary" onclick="prevStep()">‚Üê Back</button>
                        <button class="nav" onclick="nextStep()">Next &rarr;</button>
                    </div>
                </div>

                <!-- STEP 3: GENERATE ACTS -->
                <div class="step">
                    <div class="step-title">Acts: Spin the Slots</div>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 15px;">Reroll acts individually. Lock when you like them.</p>

                    <div id="actsContainer" style="display: flex; flex-direction: column; gap: 15px;"></div>

                    <div class="nav-buttons">
                        <button class="nav secondary" onclick="prevStep()">‚Üê Back</button>
                        <button class="nav" onclick="nextStep()">Next &rarr;</button>
                    </div>
                </div>

                <!-- STEP 4: EXPORT -->
                <div class="step">
                    <div class="step-title">Export & Save</div>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 15px;">Download your one-shot in any format.</p>

                    <div id="successMessage"></div>

                    <div class="export-options">
                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">Load saved session</label>
                        <div class="button-group" style="align-items: center;">
                            <select id="savedSessionsSelect" style="flex: 1;">
                                <option value="">‚Äî Choose a saved session ‚Äî</option>
                            </select>
                            <button type="button" class="export-button" onclick="loadFromLocalStorage()" style="min-width: 100px;">Load selected</button>
                        </div>
                        <button class="export-button" onclick="exportDMSheet()">üìÑ Download DM Sheet (HTML)</button>
                        <button class="export-button" onclick="exportPlayerHook()">üé≠ Download Player Hook (HTML)</button>
                        <button class="export-button" onclick="exportJSON()">‚öô Export JSON (Full State)</button>
                        <button class="export-button" onclick="exportMarkdown()">üìù Export Markdown</button>
                        <button class="export-button" onclick="saveToLocalStorage()">üíæ Save to Browser</button>
                    </div>

                    <div class="nav-buttons">
                        <button class="nav secondary" onclick="prevStep()">‚Üê Back</button>
                        <button class="nav secondary" onclick="resetWizard()">üîÑ Start Over</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- DM SHEET PREVIEW PANEL -->
        <div class="panel">
            <div class="panel-title">üìã DM Sheet Preview</div>
            <div id="dmSheetPreview" class="dm-sheet">
                <p style="color: var(--text-secondary);">Your DM sheet will appear here as you build...</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // PHASE 1: DATA MODEL & GENERATION ENGINE
        // ============================================================

        // Default lanes data (coherence constraints)
        const LANES = {
            themes: {
                faith: {
                    keywords: ['cult', 'apostasy', 'divine wrath', 'sacrifice', 'blasphemy', 'pilgrimage'],
                    villainTypes: ['cult leader', 'fallen priest', 'zealous faction'],
                    complications: ['heresy detected', 'temple defiled', 'oracle corrupted']
                },
                greed: {
                    keywords: ['theft', 'ransom', 'hoard', 'curse of wealth', 'dragon gold', 'ancient coin'],
                    villainTypes: ['crime lord', 'merchant prince', 'dragon', 'cursed artifact'],
                    complications: ['double cross', 'price increases', 'cursed treasure']
                },
                revenge: {
                    keywords: ['betrayal', 'blood feud', 'long-lost enemy', 'old scar', 'debt unpaid'],
                    villainTypes: ['spurned lover', 'old rival', 'wronged family member'],
                    complications: ['collateral damage', 'moral ambiguity', 'mistaken identity']
                },
                forbidden_magic: {
                    keywords: ['necromancy', 'ritual', 'forbidden knowledge', 'pact with evil', 'dark ritual'],
                    villainTypes: ['mad wizard', 'lich', 'warlock', 'demon summoner'],
                    complications: ['ritual goes wrong', 'components scarce', 'backlash imminent']
                },
                missing_person: {
                    keywords: ['kidnapped', 'runaway', 'amnesia', 'disguised', 'imposter'],
                    villainTypes: ['kidnapper', 'captor', 'slave trader', 'cult'],
                    complications: ['false lead', 'person doesn\'t want rescue', 'ransom demand']
                },
                relic: {
                    keywords: ['artifact', 'lost item', 'prophecy', 'ancient weapon', 'crown jewel'],
                    villainTypes: ['collector', 'grave robber', 'zealous guardian'],
                    complications: ['map is incomplete', 'guardian awakens', 'multiple factions want it']
                }
            },
            villains: {
                faction: {
                    types: ['thieves guild', 'merchant consortium', 'noble house', 'religious order', 'criminal syndicate'],
                    names: ['The Crimson Hand', 'Blackmarket Collective', 'Iron Circle', 'The Covenant']
                },
                monster_type: {
                    types: ['undead', 'fey', 'aberration', 'construct', 'fiend', 'giant', 'humanoid', 'dragon']
                },
                villain_archetype: {
                    types: ['power-hungry', 'tragic', 'naive/misled', 'alien intellect', 'personal vendetta']
                }
            },
            locations: {
                ruins: {
                    keywords: ['collapsed', 'ancient', 'lost city', 'temple', 'fortress'],
                    features: ['chasm', 'crumbling walls', 'mysterious statues', 'sealed chambers']
                },
                manor: {
                    keywords: ['noble house', 'ancestral', 'haunted', 'secret passages'],
                    features: ['library', 'crypt', 'ballroom', 'tower']
                },
                sewer: {
                    keywords: ['underground', 'flooded', 'network', 'sanctuary'],
                    features: ['fungal growth', 'rushing water', 'rat warren', 'alchemist lab']
                },
                shrine: {
                    keywords: ['holy', 'abandoned', 'corrupted', 'sacred'],
                    features: ['altar', 'font', 'stained glass', 'bell tower']
                },
                ship: {
                    keywords: ['vessel', 'sea', 'pirate', 'merchant'],
                    features: ['hold', 'crow\'s nest', 'captain\'s quarters', 'secret room']
                },
                market: {
                    keywords: ['bazaar', 'trade hub', 'undermarket', 'fair'],
                    features: ['stalls', 'back alleys', 'tavern', 'money lender']
                },
                cave: {
                    keywords: ['cavern', 'underground', 'crystal', 'underdark', 'mine'],
                    features: ['vast chamber', 'underground lake', 'crystal formations', 'narrow passages']
                }
            },
            actTypes: {
                roleplay: {
                    name: 'Roleplay',
                    icon: 'üé≠',
                    beats: ['Meet NPCs', 'Get information', 'Make deal/promise']
                },
                investigation: {
                    name: 'Investigation',
                    icon: 'üîç',
                    beats: ['Search location', 'Find clues', 'Piece together truth']
                },
                combat: {
                    name: 'Combat',
                    icon: '‚öî',
                    beats: ['Ambush/encounter', 'Main combat', 'Chase/retreat']
                },
                exploration: {
                    name: 'Exploration',
                    icon: 'üó∫',
                    beats: ['Navigate hazards', 'Discover location', 'Uncover secret']
                },
                skill_challenge: {
                    name: 'Skill Challenge',
                    icon: 'üéØ',
                    beats: ['Set challenge', 'Rising difficulty', 'Resolution']
                }
            }
        };

        // Simple seeded RNG
        class SeededRandom {
            constructor(seed) {
                this.seed = seed ? this.hashSeed(seed) : Math.random() * 10000;
            }

            hashSeed(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = ((hash << 5) - hash) + str.charCodeAt(i);
                    hash = hash & hash;
                }
                return Math.abs(hash);
            }

            next() {
                this.seed = (this.seed * 9301 + 49297) % 233280;
                return this.seed / 233280;
            }

            pick(array) {
                return array[Math.floor(this.next() * array.length)];
            }

            range(min, max) {
                return min + Math.floor(this.next() * (max - min + 1));
            }
        }

        // Main state object
        let state = {
            meta: {
                level: 5,
                partySize: 4,
                duration: 3,
                tone: 'heroic',
                seed: '',
                boundaries: []
            },
            anchors: {
                theme: '',
                villain: '',
                location: '',
                clockSteps: 6,
                clockCurrent: 0
            },
            acts: [],
            locked: [false, false, false],
            carryovers: []
        };

        let rng = new SeededRandom();
        let currentStep = 1;

        // ============================================================
        // ACT GENERATION ENGINE
        // ============================================================

        function generateAct(type, anchors, seed, actIndex, totalActs) {
            const rng = new SeededRandom(seed);
            const typeData = LANES.actTypes[type];
            const theme = anchors.theme ? LANES.themes[anchors.theme] : null;

            const isLastAct = (actIndex + 1) === totalActs;
            const exitTrigger = isLastAct ? 'Conclusion / finale' : `Proceed to Act ${actIndex + 2}`;

            const objectives = {
                roleplay: [
                    'Meet and gather info from key NPCs',
                    'Negotiate a deal or alliance',
                    'Uncover secret motivations'
                ],
                investigation: [
                    'Search location for clues',
                    'Piece together what happened',
                    'Discover the truth before enemies'
                ],
                combat: [
                    'Survive an ambush',
                    'Defeat the opposing force',
                    'Escape with objective'
                ],
                exploration: [
                    'Navigate hazards and traps',
                    'Map the unknown location',
                    'Find the hidden chamber'
                ],
                skill_challenge: [
                    'Pass a series of escalating challenges',
                    'Prove your capability',
                    'Overcome a natural obstacle'
                ]
            };

            const objective = rng.pick(objectives[type]);
            const beats = typeData.beats.map(beat => {
                const complication = theme ? rng.pick(theme.complications) : 'unexpected twist';
                return `${beat} ‚Üí ${complication}`;
            });

            return {
                type,
                objective,
                beats,
                exitTrigger
            };
        }

        // ============================================================
        // PHASE 2: EXPORTS
        // ============================================================

        function buildDMSheet() {
            let html = '';
            html += `<h2>THEME: ${state.anchors.theme?.toUpperCase() || 'UNKNOWN'}</h2>`;
            html += `<div class="dm-sheet-row"><span class="dm-sheet-label">Villain:</span><span class="dm-sheet-value">${state.anchors.villain || '‚Äî'}</span></div>`;
            html += `<div class="dm-sheet-row"><span class="dm-sheet-label">Location:</span><span class="dm-sheet-value">${state.anchors.location || '‚Äî'}</span></div>`;
            html += `<div class="dm-sheet-row"><span class="dm-sheet-label">Party Level:</span><span class="dm-sheet-value">${state.meta.level}</span></div>`;
            if (state.meta.boundaries && state.meta.boundaries.length > 0) {
                html += `<div class="dm-sheet-row"><span class="dm-sheet-label">Content boundaries:</span><span class="dm-sheet-value">${state.meta.boundaries.join(', ')}</span></div>`;
            }

            html += `<h2>Clock (${state.anchors.clockSteps} Steps)</h2>`;
            for (let i = 1; i <= state.anchors.clockSteps; i++) {
                html += `<div class="dm-sheet-row"><span class="dm-sheet-label">Step ${i}:</span><span class="dm-sheet-value">[ ]</span></div>`;
            }

            state.acts.forEach((act, idx) => {
                html += `<h2>Act ${idx + 1}: ${act.type.toUpperCase()}</h2>`;
                html += `<h3>Objective</h3>`;
                html += `<div class="dm-sheet-row"><span class="dm-sheet-value">${act.objective}</span></div>`;
                html += `<h3>Beats</h3>`;
                act.beats.forEach((beat) => {
                    html += `<div class="dm-sheet-row"><span class="dm-sheet-value">‚Ä¢ ${beat}</span></div>`;
                });
                html += `<h3>Exit Trigger</h3>`;
                html += `<div class="dm-sheet-row"><span class="dm-sheet-value">${act.exitTrigger}</span></div>`;
            });

            return html;
        }

        function updateDMSheetPreview() {
            document.getElementById('dmSheetPreview').innerHTML = buildDMSheet();
        }

        function downloadFile(filename, content, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showSuccess(`Downloaded: ${filename}`);
        }

        function exportDMSheet() {
            const html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>DM Sheet - One Shot</title>
    <style>
        body { font-family: 'Courier New', monospace; padding: 40px; max-width: 800px; margin: 0 auto; }
        h2 { margin-top: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        h3 { margin-top: 15px; }
        .row { margin: 8px 0; }
        @media print { body { padding: 20px; } }
    </style>
</head>
<body>
    ${buildDMSheet()}
</body>
</html>`;
            downloadFile('dm-sheet.html', html, 'text/html');
        }

        function exportPlayerHook() {
            const hook = state.acts[0]?.objective || 'A mysterious invitation arrives...';
            const html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Player Hook - One Shot</title>
    <style>
        body { font-family: Georgia, serif; padding: 40px; max-width: 600px; margin: 0 auto; line-height: 1.8; }
        h1 { text-align: center; }
    </style>
</head>
<body>
    <h1>Your Adventure Awaits</h1>
    <p><strong>Tone:</strong> ${state.meta.tone}</p>
    <p><strong>Setting:</strong> ${state.anchors.location || 'A mysterious location'}</p>
    <p><strong>The Hook:</strong></p>
    <p>${hook}</p>
    <p style="margin-top: 40px; color: #666;">Prepare yourselves, adventurers...</p>
</body>
</html>`;
            downloadFile('player-hook.html', html, 'text/html');
        }

        function exportJSON() {
            const json = JSON.stringify(state, null, 2);
            downloadFile('oneshot-state.json', json, 'application/json');
        }

        function exportMarkdown() {
            let md = `# One-Shot: ${state.anchors.theme || 'Untitled'}\n\n`;
            md += `**Party Level:** ${state.meta.level} | **Size:** ${state.meta.partySize} | **Tone:** ${state.meta.tone}\n\n`;
            md += `## Anchors\n`;
            md += `- **Theme:** ${state.anchors.theme}\n`;
            md += `- **Villain:** ${state.anchors.villain}\n`;
            md += `- **Location:** ${state.anchors.location}\n`;
            if (state.meta.boundaries && state.meta.boundaries.length > 0) {
                md += `- **Content boundaries:** ${state.meta.boundaries.join(', ')}\n`;
            }
            md += `\n`;
            state.acts.forEach((act, idx) => {
                md += `## Act ${idx + 1}: ${act.type}\n`;
                md += `**Objective:** ${act.objective}\n\n`;
                md += `### Beats\n`;
                act.beats.forEach(beat => md += `- ${beat}\n`);
                md += `\n`;
            });
            downloadFile('oneshot.md', md, 'text/markdown');
        }

        function saveToLocalStorage() {
            const saved = JSON.parse(localStorage.getItem('oneShotSessions') || '[]');
            const session = {
                ...state,
                savedAt: new Date().toISOString(),
                id: Math.random().toString(36).substr(2, 9)
            };
            saved.push(session);
            localStorage.setItem('oneShotSessions', JSON.stringify(saved));
            populateSavedSessionsSelect();
            showSuccess('Session saved to browser!');
        }

        function populateSavedSessionsSelect() {
            const saved = JSON.parse(localStorage.getItem('oneShotSessions') || '[]');
            const sel = document.getElementById('savedSessionsSelect');
            sel.innerHTML = '<option value="">‚Äî Choose a saved session ‚Äî</option>';
            saved.slice().reverse().forEach((s, i) => {
                const date = s.savedAt ? new Date(s.savedAt).toLocaleString() : 'Unknown';
                const id = s.id || i;
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = `${date} (${id})`;
                sel.appendChild(opt);
            });
        }

        function loadFromLocalStorage() {
            const id = document.getElementById('savedSessionsSelect').value;
            if (!id) {
                showSuccess('Select a session first.');
                return;
            }
            const saved = JSON.parse(localStorage.getItem('oneShotSessions') || '[]');
            const session = saved.find(s => s.id === id);
            if (!session) {
                showSuccess('Session not found.');
                return;
            }
            const acts = session.acts || [];
            const locked = (session.locked && session.locked.length === acts.length) ? session.locked : acts.map(() => false);
            state = {
                meta: session.meta || state.meta,
                anchors: session.anchors || state.anchors,
                acts,
                locked,
                carryovers: session.carryovers || []
            };
            rng = new SeededRandom(state.meta.seed || '');
            document.getElementById('partyLevel').value = state.meta.level;
            document.getElementById('partySize').value = state.meta.partySize;
            document.getElementById('sessionLength').value = state.meta.duration;
            document.getElementById('tone').value = state.meta.tone;
            document.getElementById('seed').value = state.meta.seed || '';
            document.getElementById('boundaries').value = (state.meta.boundaries || []).join(', ');
            document.getElementById('themeSelect').value = state.anchors.theme || '';
            document.getElementById('villainSelect').value = state.anchors.villain || '';
            document.getElementById('locationSelect').value = state.anchors.location || '';
            document.getElementById('clockSteps').value = state.anchors.clockSteps;
            document.getElementById('clockDisplay').textContent = `${state.anchors.clockSteps} steps`;
            renderActCards();
            updateDMSheetPreview();
            showSuccess('Session loaded.');
        }

        function showSuccess(msg) {
            const msgEl = document.getElementById('successMessage');
            msgEl.innerHTML = `<div class="success-message">${msg}</div>`;
            setTimeout(() => {
                msgEl.innerHTML = '';
            }, 3000);
        }

        // ============================================================
        // PHASE 3: UI LOGIC
        // ============================================================

        function nextStep() {
            if (currentStep < 4) {
                // Capture state from current step
                if (currentStep === 1) {
                    state.meta.level = parseInt(document.getElementById('partyLevel').value);
                    state.meta.partySize = parseInt(document.getElementById('partySize').value);
                    state.meta.duration = parseFloat(document.getElementById('sessionLength').value);
                    state.meta.tone = document.getElementById('tone').value;
                    state.meta.seed = document.getElementById('seed').value;
                    state.meta.boundaries = document.getElementById('boundaries').value.split(',').map(b => b.trim()).filter(b => b.length > 0);
                    rng = new SeededRandom(state.meta.seed);
                } else if (currentStep === 2) {
                    state.anchors.theme = document.getElementById('themeSelect').value;
                    state.anchors.villain = document.getElementById('villainSelect').value;
                    state.anchors.location = document.getElementById('locationSelect').value;
                    state.anchors.clockSteps = parseInt(document.getElementById('clockSteps').value);
                    
                    // Auto-generate acts when moving to step 3 (always regenerate so anchors are reflected)
                    const actTypeKeys = Object.keys(LANES.actTypes).slice(0, 3);
                    const totalActs = actTypeKeys.length;
                    state.acts = actTypeKeys.map((type, idx) =>
                        generateAct(type, state.anchors, `${state.meta.seed}-act${idx}`, idx, totalActs)
                    );
                    state.locked = state.acts.map(() => false);
                    renderActCards();
                }

                currentStep++;
                document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.step')[currentStep - 1].classList.add('active');
                document.getElementById('stepNumber').textContent = currentStep;
                if (currentStep === 4) populateSavedSessionsSelect();
                updateDMSheetPreview();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.step')[currentStep - 1].classList.add('active');
                document.getElementById('stepNumber').textContent = currentStep;
            }
        }

        function resetWizard() {
            if (confirm('Start over? (You can save your current session first.)')) {
                state = {
                    meta: { level: 5, partySize: 4, duration: 3, tone: 'heroic', seed: '', boundaries: [] },
                    anchors: { theme: '', villain: '', location: '', clockSteps: 6, clockCurrent: 0 },
                    acts: [],
                    locked: [false, false, false],
                    carryovers: []
                };
                currentStep = 1;
                document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.step')[0].classList.add('active');
                document.getElementById('stepNumber').textContent = '1';
                document.getElementById('partyLevel').value = 5;
                document.getElementById('partySize').value = 4;
                document.getElementById('sessionLength').value = 3;
                document.getElementById('tone').value = 'heroic';
                document.getElementById('seed').value = '';
                document.getElementById('boundaries').value = '';
                document.getElementById('themeSelect').value = '';
                document.getElementById('villainSelect').value = '';
                document.getElementById('locationSelect').value = '';
                document.getElementById('clockSteps').value = 6;
                document.getElementById('clockDisplay').textContent = '6 steps';
                updateDMSheetPreview();
            }
        }

        function randomizeTheme() {
            const themes = Object.keys(LANES.themes);
            document.getElementById('themeSelect').value = rng.pick(themes);
        }

        function randomizeVillain() {
            const villains = Object.keys(LANES.villains);
            document.getElementById('villainSelect').value = rng.pick(villains);
        }

        function randomizeLocation() {
            const locs = Object.keys(LANES.locations);
            document.getElementById('locationSelect').value = rng.pick(locs);
        }

        function renderActCards() {
            const container = document.getElementById('actsContainer');
            container.innerHTML = '';
            state.acts.forEach((act, idx) => {
                const card = document.createElement('div');
                card.className = 'act-preview';
                card.innerHTML = `
                    <div class="act-header">
                        <span class="act-type">${LANES.actTypes[act.type].icon} Act ${idx + 1}: ${act.type.toUpperCase()}</span>
                        <div class="act-controls">
                            <button class="secondary" onclick="rerollAct(${idx})">üé≤ Reroll</button>
                            <button class="secondary" onclick="toggleLock(${idx})">${state.locked[idx] ? 'üîí' : 'üîì'}</button>
                        </div>
                    </div>
                    <div><strong>Objective:</strong> ${act.objective}</div>
                    ${act.beats.map(beat => `<div class="beat">‚Ä¢ ${beat}</div>`).join('')}
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;">‚Üí ${act.exitTrigger}</div>
                `;
                container.appendChild(card);
            });
        }

        function rerollAct(idx) {
            if (!state.locked[idx]) {
                const actTypes = Object.keys(LANES.actTypes);
                const newType = rng.pick(actTypes);
                const totalActs = state.acts.length;
                state.acts[idx] = generateAct(newType, state.anchors, `${state.meta.seed}-act${idx}-${Math.random()}`, idx, totalActs);
                renderActCards();
                updateDMSheetPreview();
            } else {
                alert('This act is locked. Unlock it first.');
            }
        }

        function toggleLock(idx) {
            state.locked[idx] = !state.locked[idx];
            renderActCards();
        }

        // Clock range display
        document.getElementById('clockSteps')?.addEventListener('input', (e) => {
            document.getElementById('clockDisplay').textContent = `${e.target.value} steps`;
        });

        // Initialize preview on page load
        updateDMSheetPreview();
    </script>
</body>
</html>
