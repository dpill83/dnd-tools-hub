<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>QBasic-Style Editor - D&D Tools Hub</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%230000aa'/%3E%3Ctext x='16' y='22' font-family='Consolas, monospace' font-size='18' fill='%2300ffff' text-anchor='middle'%3EQ%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <link rel="stylesheet" href="../global.css">
    <link rel="stylesheet" href="qbasic-editor.css">
</head>
<body>
    <div class="qb-page" id="qb-page">
        <header class="qb-menu-bar">
            <nav class="qb-menu-items" aria-label="Menu">
                <div class="qb-menu-file-wrap">
                    <button type="button" class="qb-menu-trigger" id="qb-file-trigger" aria-haspopup="true" aria-expanded="false" aria-label="File menu">File</button>
                    <ul class="qb-file-dropdown" id="qb-file-dropdown" role="menu" aria-label="File">
                        <li role="none"><button type="button" role="menuitem" id="qb-file-new">New</button></li>
                        <li role="none"><button type="button" role="menuitem" id="qb-file-open">Open...</button></li>
                        <li role="none"><button type="button" role="menuitem" id="qb-file-save">Save</button></li>
                        <li role="none"><button type="button" role="menuitem" id="qb-file-save-as">Save As...</button></li>
                    </ul>
                </div>
                <input type="file" id="qb-file-input" accept=".txt,.nfo,.md,.log,.csv,.json,.xml,.ini,.cfg,.yml,.yaml,.html,.css,.js,.ts,.tsx,.jsx,text/plain" aria-hidden="true" tabindex="-1">
                <div class="qb-menu-file-wrap">
                    <button type="button" class="qb-menu-trigger" id="qb-view-trigger" aria-haspopup="true" aria-expanded="false" aria-label="View menu">View</button>
                    <ul class="qb-file-dropdown" id="qb-view-dropdown" role="menu" aria-label="View">
                        <li role="none"><button type="button" role="menuitem" id="qb-view-wordwrap">Word wrap: On</button></li>
                    </ul>
                </div>
                <span class="qb-menu-static">Search Run Debug Options Help</span>
            </nav>
            <div class="qb-doc-title" id="qb-doc-title">Untitled</div>
            <div class="qb-header-actions">
                <a href="../index.html" class="qb-menu-btn" aria-label="Go to home">&#127968;</a>
                <button type="button" id="theme-toggle" class="qb-menu-btn" aria-label="Toggle dark mode">&#127769;</button>
            </div>
        </header>

        <div class="qb-editor-frame">
            <textarea id="qb-editor" spellcheck="false" placeholder="Type here..." aria-label="Editor content"></textarea>
        </div>

        <div class="qb-immediate-sep" aria-hidden="true"></div>
        <div class="qb-immediate-bar">
            <span class="qb-immediate-label">Immediate</span>
        </div>

        <footer class="qb-status-bar">
            <span class="qb-status-keys">&lt;Ctrl+O=Open&gt; &lt;Ctrl+S=Save&gt; &lt;Ctrl+N=New&gt;</span>
            <span class="qb-status-pos" id="qb-status-pos">CN 00001 001</span>
        </footer>
    </div>

    <script src="../theme.js"></script>
    <script>
(function() {
    'use strict';
    var STORAGE_KEY = 'qbasic-editor-content';
    var TITLE_KEY = 'qbasic-editor-title';
    var WRAP_KEY = 'qbasic-editor-wordwrap';
    var DEBOUNCE_MS = 400;
    var editor = document.getElementById('qb-editor');
    var statusPos = document.getElementById('qb-status-pos');
    var saveTimer = null;

    editor.value = localStorage.getItem(STORAGE_KEY) || '';
    editor.setAttribute('wrap', localStorage.getItem(WRAP_KEY) === 'off' ? 'off' : 'soft');

    function save() {
        localStorage.setItem(STORAGE_KEY, editor.value);
    }

    function updateLineCol() {
        var text = editor.value;
        var pos = editor.selectionStart;
        var line = 1;
        var col = 1;
        for (var i = 0; i < pos && i < text.length; i++) {
            if (text[i] === '\n') {
                line++;
                col = 1;
            } else {
                col++;
            }
        }
        statusPos.textContent = 'CN ' + String(line).padStart(5, '0') + ' ' + String(col).padStart(3, '0');
    }

    function saveNow() {
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = null;
        save();
    }

    function newDoc() {
        if (editor.value && !confirm('Clear document? This cannot be undone.')) return;
        editor.value = '';
        saveNow();
        updateLineCol();
        setDocTitle('Untitled');
    }

    function setDocTitle(name) {
        var el = document.getElementById('qb-doc-title');
        if (el) {
            el.textContent = name;
            localStorage.setItem(TITLE_KEY, name);
        }
    }

    function getSuggestedFilename() {
        var title = (document.getElementById('qb-doc-title') && document.getElementById('qb-doc-title').textContent) || 'Untitled';
        return title.indexOf('.') === -1 ? title + '.txt' : title;
    }

    function saveAs() {
        saveNow();
        var content = editor.value;
        var suggested = getSuggestedFilename();
        if (typeof window.showSaveFilePicker === 'function') {
            window.showSaveFilePicker({
                suggestedName: suggested,
                types: [{ description: 'Text files', accept: { 'text/plain': ['.txt', '.md', '.nfo', '.log', '.json', '.xml', '.html', '.css', '.js'] } }]
            }).then(function(handle) {
                return handle.createWritable().then(function(writable) {
                    return writable.write(content).then(function() { return writable.close(); });
                }).then(function() { return handle.name; });
            }).then(function(name) {
                setDocTitle(name);
            }).catch(function(err) {
                if (err.name !== 'AbortError') downloadFallback(content, suggested);
            });
        } else {
            downloadFallback(content, suggested);
        }
    }

    function downloadFallback(content, filename) {
        var blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    editor.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            saveNow();
        } else if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            newDoc();
        } else if (e.ctrlKey && e.key === 'o') {
            e.preventDefault();
            fileInput.value = '';
            fileInput.click();
        }
    });
    editor.addEventListener('input', function() {
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(save, DEBOUNCE_MS);
        updateLineCol();
    });
    editor.addEventListener('click', updateLineCol);
    editor.addEventListener('keyup', updateLineCol);
    updateLineCol();

    var fileTrigger = document.getElementById('qb-file-trigger');
    var fileDropdown = document.getElementById('qb-file-dropdown');

    function closeFileMenu() {
        fileDropdown.classList.remove('open');
        fileTrigger.setAttribute('aria-expanded', 'false');
    }

    fileTrigger.addEventListener('click', function(e) {
        e.stopPropagation();
        var open = fileDropdown.classList.toggle('open');
        fileTrigger.setAttribute('aria-expanded', open ? 'true' : 'false');
    });

    var fileInput = document.getElementById('qb-file-input');
    var docTitle = document.getElementById('qb-doc-title');
    docTitle.textContent = localStorage.getItem(TITLE_KEY) || 'Untitled';

    document.getElementById('qb-file-new').addEventListener('click', function() {
        newDoc();
        closeFileMenu();
    });
    document.getElementById('qb-file-open').addEventListener('click', function() {
        closeFileMenu();
        fileInput.value = '';
        fileInput.click();
    });
    document.getElementById('qb-file-save').addEventListener('click', function() {
        saveNow();
        closeFileMenu();
    });
    document.getElementById('qb-file-save-as').addEventListener('click', function() {
        saveAs();
        closeFileMenu();
    });

    fileInput.addEventListener('change', function() {
        var file = fileInput.files && fileInput.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function() {
            editor.value = typeof reader.result === 'string' ? reader.result : '';
            saveNow();
            updateLineCol();
            setDocTitle(file.name);
        };
        reader.readAsText(file);
    });

    var viewTrigger = document.getElementById('qb-view-trigger');
    var viewDropdown = document.getElementById('qb-view-dropdown');
    var wordwrapBtn = document.getElementById('qb-view-wordwrap');

    function closeViewMenu() {
        viewDropdown.classList.remove('open');
        viewTrigger.setAttribute('aria-expanded', 'false');
    }

    function updateWordWrapLabel() {
        var on = editor.getAttribute('wrap') !== 'off';
        wordwrapBtn.textContent = on ? 'Word wrap: On' : 'Word wrap: Off';
    }

    viewTrigger.addEventListener('click', function(e) {
        e.stopPropagation();
        var open = viewDropdown.classList.toggle('open');
        viewTrigger.setAttribute('aria-expanded', open ? 'true' : 'false');
    });

    wordwrapBtn.addEventListener('click', function() {
        var on = editor.getAttribute('wrap') !== 'off';
        editor.setAttribute('wrap', on ? 'off' : 'soft');
        localStorage.setItem(WRAP_KEY, on ? 'off' : 'soft');
        updateWordWrapLabel();
        closeViewMenu();
    });

    updateWordWrapLabel();

    document.addEventListener('click', function() {
        closeFileMenu();
        closeViewMenu();
    });
})();
    </script>
</body>
</html>
